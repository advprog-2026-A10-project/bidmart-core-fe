name: CD

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed

concurrency:
  group: cd-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

permissions:
  contents: read
  deployments: write

jobs:
  deploy-staging:
    name: Deploy to staging
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' && github.event.workflow_run.head_branch == 'staging' }}
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Trigger staging deploy webhook
        env:
          DEPLOY_WEBHOOK_URL: ${{ secrets.STAGING_DEPLOY_WEBHOOK_URL }}
        run: |
          if [ -z "$DEPLOY_WEBHOOK_URL" ]; then
            echo "Missing STAGING_DEPLOY_WEBHOOK_URL secret."
            exit 1
          fi

          curl --fail --show-error --silent -X POST "$DEPLOY_WEBHOOK_URL"
          echo "Staging deployment triggered."

  deploy-production:
    name: Deploy to production
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Trigger production deploy webhook
        env:
          DEPLOY_WEBHOOK_URL: ${{ secrets.PRODUCTION_DEPLOY_WEBHOOK_URL }}
        run: |
          if [ -z "$DEPLOY_WEBHOOK_URL" ]; then
            echo "Missing PRODUCTION_DEPLOY_WEBHOOK_URL secret."
            exit 1
          fi

          curl --fail --show-error --silent -X POST "$DEPLOY_WEBHOOK_URL"
          echo "Production deployment triggered."
